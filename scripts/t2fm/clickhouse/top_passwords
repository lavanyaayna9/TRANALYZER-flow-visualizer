-- Top cleartext passwords by number of flows

SELECT
    replaceRegexpOne(IPv6NumToString(sip.2), '^::ffff:', ''),
    replaceRegexpOne(IPv6NumToString(dip.2), '^::ffff:', ''),
    CASE "pwxType"
        WHEN  1 THEN 'FTP'
        WHEN  2 THEN 'POP3'
        WHEN  3 THEN 'IMAP'
        WHEN  4 THEN 'SMTP'
        WHEN  5 THEN 'HTTP Basic'
        WHEN  6 THEN 'HTTP Proxy'
        WHEN  7 THEN 'HTTP GET'
        WHEN  8 THEN 'HTTP POST'
        WHEN  9 THEN 'IRC'
        WHEN 10 THEN 'Telnet'
        WHEN 11 THEN 'LDAP'
        WHEN 12 THEN 'PAP'
        ELSE "pwxType"::TEXT
    END AS proto,
    toValidUTF8(username),
    toValidUTF8(pass),
    COUNT(*) AS cnt

FROM (
    -- A flows
    SELECT
        "srcIP" AS sip,
        "dstIP" AS dip,
        "pwxType",
        "pwxUser" AS username,
        "pwxPass" AS pass
    FROM
        flow
    WHERE
        bitTest("flowStat", 0) = 0
        AND "timeFirst" >= {time_from:DateTime64(6)}
        AND "timeLast" <= {time_to:DateTime64(6)}

    UNION ALL

    -- B flows
    SELECT
        "dstIP" AS sip,
        "srcIP" AS dip,
        "pwxType",
        "pwxUser" AS username,
        "pwxPass" AS pass
    FROM
        flow
    WHERE
        bitTest("flowStat", 0) = 1
        AND "timeFirst" >= {time_from:DateTime64(6)}
        AND "timeLast" <= {time_to:DateTime64(6)}
) AS flows

WHERE "pwxType" != '0' AND (username != '' OR pass != '')

GROUP BY sip, dip, proto, username, pass
ORDER BY multiply(cnt, {sort_order:Int8})

LIMIT {n:UInt64}
