-- Top source IP by number of packets

SELECT
    replaceRegexpOne(IPv6NumToString(ip.2), '^::ffff:', ''),
    CASE WHEN match(cc, '^\d+') THEN '--'
         WHEN cc = '--'         THEN 'N/A'
         WHEN cc = '-'          THEN 'N/A'
         WHEN LOWER(cc) = 'ff'  THEN 'N/A'
         ELSE UPPER(toValidUTF8(cc))
    END AS cn,
    SUM(pkts) AS cnt

FROM (
    -- A flows
    SELECT
        "srcIP" AS ip,
        "srcIPCC" AS cc,
        "pktsSnt" AS pkts
    FROM
        flow
    WHERE
        "dir" = 'A'
        AND bitTest("flowStat", 0) = 0
        AND bitTestAny("flowStat", 14, 15) > 0  -- IPv4/6 only
        AND "timeFirst" >= {time_from:DateTime64(6)}
        AND "timeLast" <= {time_to:DateTime64(6)}

    UNION ALL

    -- B flows
    SELECT
        "dstIP" AS ip,
        "dstIPCC" AS cc,
        "pktsRcvd" AS pkts
    FROM
        flow
    WHERE
        "dir" = 'A'
        AND bitTest("flowStat", 0) = 1
        AND bitTestAny("flowStat", 14, 15) > 0  -- IPv4/6 only
        AND "timeFirst" >= {time_from:DateTime64(6)}
        AND "timeLast" <= {time_to:DateTime64(6)}
) AS flows

GROUP BY ip, cn
ORDER BY multiply(cnt, {sort_order:Int8})

LIMIT {n:UInt64}
