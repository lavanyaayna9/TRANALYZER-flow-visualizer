CC             ?= gcc

RM             := rm -f
UNAME_S        := $(shell uname -s)

CFLAGS_DEFAULT := -pipe -Wall -Wextra -Wundef -std=gnu99 -MMD -MP \
                  -I.. -I../../tranalyzer2/src

ifeq ($(UNAME_S), Darwin)
CFLAGS_DEFAULT += -D_DARWIN_C_SOURCE
else
CFLAGS_DEFAULT += -D_GNU_SOURCE
endif

CFLAGS         := $(CFLAGS_DEFAULT) -O2
CFLAGS_DEBUG   := $(CFLAGS_DEFAULT) -O0 -g2 -ggdb

LDLIBS         := -lm

# IPv4 utilities
SRC4           := mrgasn4.c mrgipl4.c
EXEC4          := $(SRC4:.c=)
OBJS4          := $(SRC4:.c=.o)
DEPS4          := $(OBJS4:.o=.d)

# IPv6 utilities
SRC6           := mrgasn6.c mrgipl6.c
EXEC6          := $(SRC6:.c=)
OBJS6          := $(SRC6:.c=.o)
DEPS6          := $(OBJS6:.o=.d)

EXEC           := $(EXEC4) $(EXEC6)
SRC            := $(wildcard *.c)
OBJS           := $(SRC:.c=.o)
DEPS           := $(OBJS:.o=.d)

.PHONY: all debug utils_v4 utils_v6

all: utils_v4 utils_v6

utils_v4: $(EXEC4)

utils_v6: $(EXEC6)

debug: CFLAGS=$(CFLAGS_DEBUG)
debug: all

mrgasn: mrgasn4 mrgasn6

mrgipl: mrgipl4 mrgipl6

# SRC4

mrgasn4: mrgasn4.o ../subnetHL4.o ../t2utils.o
	$(CC) $(LDFLAGS) -o $@ $^ $(LDLIBS)

mrgipl4: mrgipl4.o ../subnetHL4.o ../t2utils.o
	$(CC) $(LDFLAGS) -o $@ $^ $(LDLIBS)


# SRC6

mrgasn6: mrgasn6.o ../subnetHL6.o ../t2utils.o
	$(CC) $(LDFLAGS) -o $@ $^ $(LDLIBS)

mrgipl6: mrgipl6.o ../subnetHL6.o ../t2utils.o
	$(CC) $(LDFLAGS) -o $@ $^ $(LDLIBS)

-include $(DEPS)

.PHONY: clean clean_v4 clean_v6

clean:
	$(RM) $(OBJS) $(DEPS)

clean_v4:
	$(RM) $(OBJS4) $(DEPS4)

clean_v6:
	$(RM) $(OBJS6) $(DEPS6)

.PHONY: mrproper mrproper_v4 mrproper_v6

mrproper: clean
	$(RM) $(EXEC)

mrproper_v4: clean_v4
	$(RM) $(EXEC4) $(EXTRA4)

mrproper_v6: clean_v6
	$(RM) $(EXEC6) $(EXTRA6)

.PHONY: distclean distclean_v4 distclean_v6

distclean: mrproper
	make -C tor distclean

distclean_v4: mrproper_v4

distclean_v6: mrproper_v6
