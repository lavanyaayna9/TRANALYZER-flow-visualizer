\IfFileExists{t2doc.cls}{
    \documentclass[documentation]{subfiles}
}{
    \errmessage{Error: could not find t2doc.cls}
}

\begin{document}

\trantitle
    {smtpDecode}
    {Simple Mail Transfer Protocol (SMTP)}
    {Tranalyzer Development Team}

\section{smtpDecode}\label{s:smtpDecode}

\subsection{Description}
The smtpDecode plugin processes MAIL header and content information of a flow.
The idea is to identify certain mail features and CNAMES.

\subsection{Configuration Flags}
The following flags can be used to control the output of the plugin:
\begin{longtable}{>{\tt}lcl>{\tt\small}l}
    \toprule
    {\bf Name} & {\bf Default} & {\bf Description} & {\bf Flags}\\
    \midrule\endhead%
    SMTP\_SAVE    &  0 & 1: save content to {\tt\small SMTP\_F\_PATH}    & \\
    SMTP\_RMDIR   &  1 & Empty {\tt\small SMTP\_F\_PATH} before starting & SMTP\_SAVE=1\\
    SMTP\_BTFLD   &  0 & 1: Bitfield coding of SMTP commands             & \\
    SMTP\_RCTXT   &  1 & 1: print response code text                     & \\
    SMTP\_MXNMLN  & 70 & maximal name length                             & \\
    SMTP\_MXUNMLN & 25 & maximal user length                             & \\
    SMTP\_MXPNMLN & 15 & maximal PW length                               & \\
    SMTP\_MAXCNM  &  8 & maximal number rec,trans codes                  & \\
    SMTP\_MAXUNM  &  5 & maximal number server names                     & \\
    SMTP\_MAXPNM  &  5 & maximal number server names                     & \\
    SMTP\_MAXSNM  &  8 & maximal number of server addresses              & \\
    SMTP\_MAXRNM  &  8 & maximal number of rec EMail addresses           & \\
    SMTP\_MAXTNM  &  8 & maximal number of trans EMail addresses         & \\

    SMTP\_F\_PATH & {\tt\small "/tmp/SMTPFILES/"}
                       & Path for extracted content                      & \\
    SMTP\_NONAME  & {\tt\small "nudel"}
                       & No name file name                               & \\
    \bottomrule
\end{longtable}

\subsubsection{Environment Variable Configuration Flags}
The following configuration flags can also be configured with environment variables ({\tt ENVCNTRL>0}):
\begin{itemize}
    \item {\tt SMTP\_RMDIR}
    \item {\tt SMTP\_F\_PATH}
    \item {\tt SMTP\_NONAME}
\end{itemize}

\subsection{Flow File Output}
The smtpDecode plugin outputs the following columns:
\begin{longtable}{>{\tt}lll>{\tt\small}l}
    \toprule
    {\bf Column} & {\bf Type} & {\bf Description} & {\bf Flags}\\
    \midrule\endhead%
    \nameref{smtpStat} & H8   & Status                              & \\
    \nameref{smtpCBF}  & H16  & Command codes bitfield              & SMTP\_BTFLD=1\\
    smtpCC             & RSC  & Command codes                       & \\
    smtpRC             & RU16 & Response codes                      & \\
    smtpUsr            & RS   & Users                               & \\
    smtpPW             & RS   & Passwords                           & \\
    smtpSANum          & U8   & Number of server addresses          & \\
    smtpESANum         & U8   & Number of email sender addresses    & \\
    smtpERANum         & U8   & Number of email receiver addresses  & \\
    smtpSA             & RS   & Server send addresses               & \\
    smtpESA            & RS   & Email send addresses                & \\
    smtpERA            & RS   & Email receive addresses             & \\
    \bottomrule
\end{longtable}

\subsubsection{smtpStat}\label{smtpStat}
The {\tt smtpStat} column is to be interpreted as follows:
\begin{longtable}{>{\tt}rl>{\tt\small}l}
    \toprule
    {\bf smtpStat} & {\bf Description}      & {\bf Flags}\\
    \midrule\endhead%
    $2^0$ (=0x01)  & SMTP ports found       & \\
    $2^1$ (=0x02)  & Authentication pending & \\
    $2^2$ (=0x04)  & Data download pending  & SMTP\_SAVE=1\\
    $2^3$ (=0x08)  & User password pending  & \\
    \\
    $2^4$ (=0x10)  & flow write finished    & SMTP\_SAVE=1\\
    $2^5$ (=0x20)  & ---                    & \\
    $2^6$ (=0x40)  & File error             & SMTP\_SAVE=1\\
    $2^7$ (=0x80)  & Array overflow         & \\
    \bottomrule
\end{longtable}

\subsubsection{smtpCBF}\label{smtpCBF}
The {\tt smtpCBF} column is to be interpreted as follows:\\
\begin{minipage}{.48\textwidth}
    \begin{longtable}{>{\tt}rl}
        \toprule
        {\bf smtpCBF} & {\bf Description} \\
        \midrule\endhead%
        $2^{0}$  (=0x0001) & HELO\\
        $2^{1}$  (=0x0002) & EHLO\\
        $2^{2}$  (=0x0004) & MAIL\\
        $2^{3}$  (=0x0008) & RCPT\\
        \\
        $2^{4}$  (=0x0010) & DATA\\
        $2^{5}$  (=0x0020) & RSET\\
        $2^{6}$  (=0x0040) & SEND\\
        $2^{7}$  (=0x0080) & SOML\\
        \bottomrule
    \end{longtable}
\end{minipage}
\hfill
\begin{minipage}{.48\textwidth}
    \begin{longtable}{>{\tt}rl}
        \toprule
        {\bf smtpCBF} & {\bf Description} \\
        \midrule\endhead%
        $2^{8}$  (=0x0100) & SAML\\
        $2^{9}$  (=0x0200) & VRFY\\
        $2^{10}$ (=0x0400) & EXPN\\
        $2^{11}$ (=0x0800) & HELP\\
        \\
        $2^{12}$ (=0x1000) & NOOP\\
        $2^{13}$ (=0x2000) & QUIT\\
        $2^{14}$ (=0x4000) & TURN\\
        $2^{15}$ (=0x8000) & AUTH\\
        \bottomrule
    \end{longtable}
\end{minipage}

\subsection{Packet File Output}
In packet mode ({\tt --s} option), the smtpDecode plugin outputs the following columns:
\begin{longtable}{>{\tt}lll>{\tt\small}l}
    \toprule
    {\bf Column} & {\bf Type} & {\bf Description} & {\bf Flags}\\
    \midrule\endhead%
    \nameref{smtpStat} & H8 & Status & \\
    \bottomrule
\end{longtable}

\subsection{Plugin Report Output}
The following information is reported:
\begin{itemize}
    \item Aggregated {\tt\nameref{smtpStat}}
    \item Number of SMTP packets
    \item Number of SMTP files
\end{itemize}

\subsection{TODO}
\begin{itemize}
    \item fragmentation
\end{itemize}

\end{document}
